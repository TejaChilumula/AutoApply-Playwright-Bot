<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AutoApply v0.2 — Control Panel</title>
  <style>
    :root { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color-scheme: light dark; }
    body { margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 14px; border-radius: 10px; border: 1px solid #999; cursor: pointer; }
    select, input { padding: 8px 10px; border-radius: 8px; border: 1px solid #999; }
    .card { border: 1px solid #444; border-radius: 14px; padding: 16px; margin-top: 16px; }
    .muted { opacity: 0.7; }
    pre { background: #111; color: #eee; padding: 12px; border-radius: 12px; overflow: auto; }
  </style>
</head>
<body>
  <h1>AutoApply v0.2</h1>

  <div class="row">
    <label for="ats">ATS:</label>
    <select id="ats">
      <option value="greenhouse">Greenhouse</option>
      <option value="lever">Lever</option>
      <option value="ashby">Ashby</option>
      <option value="smartrecruiters">SmartRecruiters</option>
    </select>

    <label for="rate">Rate limit/hour:</label>
    <input id="rate" type="number" value="120" />

    <button id="seed">Seed from CSV</button>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
  </div>

  <div class="card">
    <h3>Status</h3>
    <div id="status"><span class="muted">Loading...</span></div>
  </div>

  <div class="card">
    <h3>Logs</h3>
    <pre id="logs"></pre>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    async function refresh() {
      const r = await fetch('/api/status');
      const j = await r.json();
      $('#status').innerHTML = '<b>Running:</b> '+j.running+' | <b>ATS:</b> '+j.ats+' | <b>Tokens:</b> '+j.rate.tokens+'/'+j.rate.capacity+'<br/>' +
        '<b>Companies:</b> '+(j.companies?.map(x=>x.ats+': '+x.c).join(' • ')||0) +
        ' | <b>Missing handles:</b> '+j.missingHandles+'<br/>' +
        '<b>Applications:</b> '+ (j.applications?.map(x=>x.status+': '+x.c).join(' • ') || 'none');
    }
    setInterval(refresh, 3000);
    refresh();

    $('#start').onclick = async ()=>{
      const ats = $('#ats').value;
      await fetch('/api/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ats }) });
      log('Started for '+ats);
      refresh();
    };
    $('#stop').onclick = async ()=>{
      await fetch('/api/stop', { method:'POST' });
      log('Stopped');
      refresh();
    };
    $('#seed').onclick = async ()=>{
      const ats = $('#ats').value;
      log('Seeding from CSV for '+ats+'...');
      const r = await fetch('/api/seed-csv', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ats }) });
      const j = await r.json();
      log('Seed result: '+JSON.stringify(j));
      refresh();
    };

    function log(msg){
      const el = $('#logs');
      el.textContent = '['+(new Date()).toLocaleTimeString()+'] '+msg+'\n'+el.textContent;
    }
  </script>
</body>
</html>
